<!DOCTYPE html>
<html>

<head>
  <title>Dynamic Route Tracing - Bucaramanga</title>
  <link type="text/css" rel="stylesheet" href="./fast.css"/>
  <script>
    (g => { var h, a, k, p = "The Google Maps JavaScript API", c = "google", l = "importLibrary", q = "__ib__", m = document, b = window; b = b[c] || (b[c] = {}); var d = b.maps || (b.maps = {}), r = new Set, e = new URLSearchParams, u = () => h || (h = new Promise(async (f, n) => { await (a = m.createElement("script")); e.set("libraries", [...r] + ""); for (k in g) e.set(k.replace(/[A-Z]/g, t => "_" + t[0].toLowerCase()), g[k]); e.set("callback", c + ".maps." + q); a.src = `https://maps.${c}apis.com/maps/api/js?` + e; d[q] = f; a.onerror = () => h = n(Error(p + " could not load.")); a.nonce = m.querySelector("script[nonce]")?.nonce || ""; m.head.append(a) })); d[l] ? console.warn(p + " only loads once. Ignoring:", g) : d[l] = (f, ...n) => r.add(f) && u().then(() => d[l](f, ...n)) })({
      key: "AIzaSyAnWWgrVioUDz3-wFjlSunUsGG4u9srYSs",
      v: "weekly",
    });
  </script>
</head>

<body>
  <div id="route-box">
    <!-- <label id="origin-label"></label>
    <label id="destination-label"></label> -->
    <button id="route-finder">
      Find Route
    </button>
  </div>

  <div id="map"></div>

  <!-- <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyAnWWgrVioUDz3-wFjlSunUsGG4u9srYSs&libraries=places&callback=initMap" async defer> -->
  </script>

  <script type="module">

    const { Place } = await google.maps.importLibrary("places");

    let map;
    let directionsService;
    let directionsRenderer;
    /**
     * @type {*}
     */
    const state = {
      inputs: {
        origin: undefined,
        destination: undefined,
      }
    };

    function initMap() {
      // Initialize the Map centered on Bucaramanga, Colombia
      /** @type {google.maps.LatLng} */
      const bucaramanga = { lat: 7.11391, lng: -73.1198 };

      map = new google.maps.Map(document.getElementById("map"), {
        zoom: 13,
        center: bucaramanga,
        mapTypeControl: false
      });

      directionsService = new google.maps.DirectionsService();
      directionsRenderer = new google.maps.DirectionsRenderer({
        map: map,
        draggable: true // Allows users to dynamically change the route by dragging markers
      });

      // Set up Autocomplete on the input fields
      setupAutocomplete(bucaramanga);

      // Optional: Recalculate if the user drags the route on the map
      directionsRenderer.addListener("directions_changed", () => {
        const directions = directionsRenderer.getDirections();
        if (directions) {
          // This logs the summary of the dynamically changed route
          console.log("Route dynamically updated. Distance:", directions.routes[0].legs[0].distance.text);
        }
      });

      document.getElementById("route-finder").onclick = calculateAndDisplayRoute;
    }

    function setupAutocomplete(location) {
      const box = document.getElementById("route-box");

      /* Set a locationBias */

      // Bias the search results towards Bucaramanga, Colombia
      // Search API
      // const options = {
      //   componentRestrictions: { country: 'co' }, // Colombia
      //   fields: ['place_id', 'geometry', 'name', 'formatted_address'],
      // };

      const options = {
        includedRegionCodes: ["co"],
        locationBias: location,
      };

      state.inputs.origin = new google.maps.places.PlaceAutocompleteElement(options);
      state.inputs.destination = new google.maps.places.PlaceAutocompleteElement(options);

      // originInput.addEventListener('place_changed', calculateAndDisplayRoute);
      // destInput.addEventListener('place_changed', calculateAndDisplayRoute);

      box.append(state.inputs.origin, state.inputs.destination);
      // destinationLabel.appendChild(destInput);
    }

    function calculateAndDisplayRoute() {
      const start = state.inputs.origin.Eg.value;
      const end = state.inputs.destination.Eg.value;

      // Only run if both fields have values
      if (!start || !end) {
        return;
      }


      // Request the route
      const request = {
        origin: start,
        destination: end,
        travelMode: google.maps.TravelMode.DRIVING,
        unitSystem: google.maps.UnitSystem.METRIC, // Use kilometers
      };

      directionsService.route(request, (response, status) => {
        if (status === 'OK') {
          directionsRenderer.setDirections(response);
        } else {
          // Display an error to the user if the route could not be found
          window.alert('Could not find a route: ' + status);
          directionsRenderer.setDirections({ routes: [] }); // Clear any previous route
        }
      });
    }

    initMap();
  </script>
</body>

</html>
<!-- 

Location Bias : https://developers.google.com/maps/documentation/javascript/reference/places-service#LocationBias

AutocompleteElement: https://developers.google.com/maps/documentation/javascript/reference/places-widget#PlaceAutocompleteElement


-->